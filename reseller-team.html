<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Builder | Tutu Reseller</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                    colors: {
                        'sidebar-dark': '#0f172a',
                        'rose-primary': '#e11d48',
                        'rose-light': '#fff1f2',
                        'rose-dark': '#be123c',
                    }
                }
            }
        }
    </script>
    <style>
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #e11d48; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-rose-light text-gray-800 font-sans antialiased overflow-hidden">

    <div class="flex h-screen">

        <aside class="w-64 bg-sidebar-dark text-white hidden md:flex flex-col flex-shrink-0 transition-all duration-300 shadow-xl" id="sidebar">
            <div class="p-6 flex items-center gap-3 border-b border-gray-700">
                <img id="sidebar-user-img" src="https://via.placeholder.com/50" alt="User" class="w-12 h-12 rounded-full border-2 border-rose-primary object-cover">
                <div>
                    <h4 id="sidebar-user-name" class="font-bold text-sm">Loading...</h4>
                    <span class="text-[10px] bg-rose-primary/20 text-rose-400 px-2 py-0.5 rounded-full border border-rose-primary/30">Reseller</span>
                </div>
            </div>
<nav class="flex-1 overflow-y-auto px-3 space-y-2 text-sm font-medium py-6">
                <a href="#" class="flex items-center gap-3 px-4 py-3 bg-gradient-to-r from-rose-primary to-rose-dark text-white rounded-xl shadow-lg shadow-rose-900/50">
                    <i class="fa fa-store w-5"></i> Marketplace
                </a>
                <a href="reseller-orders.html" class="flex items-center gap-3 px-4 py-3 text-gray-300 hover:bg-white/5 hover:text-white rounded-xl transition-colors">
                    <i class="fa fa-box-open w-5"></i> Reseller Orders
                </a>
                <a href="reseller-team.html" class="flex items-center gap-3 px-4 py-3 text-gray-300 hover:bg-white/5 hover:text-white rounded-xl transition-colors">
                    <i class="fa fa-wallet w-5"></i> My Team
                </a>
                <a href="reseller-profile.html" class="flex items-center gap-3 px-4 py-3 text-gray-300 hover:bg-white/5 hover:text-white rounded-xl transition-colors">
                    <i class="fa fa-user-circle w-5"></i> Profile
                </a>
            </nav>

        </aside>

        <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
            
            <header class="bg-white shadow-sm p-4 flex justify-between items-center md:hidden z-10 shrink-0">
                <button onclick="document.getElementById('sidebar').classList.toggle('hidden'); document.getElementById('sidebar').classList.toggle('absolute'); document.getElementById('sidebar').classList.toggle('z-50'); document.getElementById('sidebar').classList.toggle('h-full');" class="text-gray-600 text-xl">
                    <i class="fa fa-bars"></i>
                </button>
                <h1 class="font-bold text-xl text-rose-primary">Team Builder</h1>
                <div class="w-6"></div>
            </header>

            <div class="flex-1 overflow-y-auto p-4 md:p-8 bg-rose-light/50">
                <div class="max-w-4xl mx-auto space-y-6">
                    
                    <div class="flex justify-end">
                        <button class="bg-white text-rose-600 px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-rose-50 flex items-center gap-2 transition-colors border border-rose-100">
                            <i class="fa fa-graduation-cap"></i> How it works!
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between h-40 relative overflow-hidden group hover:shadow-md transition-shadow">
                            <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                <i class="fa fa-users text-8xl text-orange-500"></i>
                            </div>
                            <div>
                                <h2 class="text-5xl font-black text-gray-800" id="teamCount">0</h2>
                                <p class="text-orange-500 font-bold mt-1 flex items-center gap-2">
                                    <i class="fa fa-users"></i> My Team Members
                                </p>
                            </div>
                            <button onclick="document.getElementById('teamListSection').scrollIntoView({behavior: 'smooth'})" class="text-sm text-gray-400 underline hover:text-rose-600 self-start mt-2">View Team Details</button>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between h-40 relative overflow-hidden group hover:shadow-md transition-shadow">
                            <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                <i class="fa fa-coins text-8xl text-rose-500"></i>
                            </div>
                            <div>
                                <h2 class="text-4xl font-black text-gray-800">LKR <span id="bonusAmount">0</span></h2>
                                <p class="text-rose-500 font-bold mt-1 flex items-center gap-2">
                                    <i class="fa fa-money-bill-wave"></i> Total Bonus Pending
                                </p>
                            </div>
                            <button class="text-sm text-gray-400 underline hover:text-rose-600 self-start mt-2">View Bonus History</button>
                        </div>
                    </div>

                    <div class="bg-gradient-to-r from-rose-500 to-rose-600 rounded-2xl p-6 md:p-8 text-white shadow-xl shadow-rose-200 relative overflow-hidden">
                        <div class="absolute -right-10 -top-10 bg-white/10 w-40 h-40 rounded-full blur-2xl"></div>
                        <div class="absolute -left-10 -bottom-10 bg-white/10 w-40 h-40 rounded-full blur-2xl"></div>
                        
                        <h3 class="text-xl font-bold mb-2 flex items-center gap-2">
                            Referral Link <i class="fa fa-question-circle text-rose-200 text-sm cursor-pointer" title="Share this link"></i>
                        </h3>
                        <p class="text-rose-100 text-sm mb-6 max-w-lg">Share this link with your friends. When they register and start selling, you earn a commission on their sales!</p>

                        <div class="bg-white/20 backdrop-blur-md p-2 rounded-xl flex items-center gap-2 border border-white/30">
                            <div class="bg-white/20 rounded-lg p-2 text-rose-100">
                                <i class="fa fa-link"></i>
                            </div>
                            <input type="text" id="referralLink" value="Generating..." readonly class="bg-transparent text-white w-full px-2 py-2 outline-none font-mono text-sm placeholder-rose-200 tracking-wide">
                            
                            <button onclick="copyReferral()" class="bg-white text-rose-600 px-6 py-3 rounded-lg font-bold hover:bg-rose-50 transition-colors flex items-center gap-2 shadow-lg whitespace-nowrap transform active:scale-95">
                                Copy Link
                            </button>
                        </div>
                    </div>

                    <div id="teamListSection">
                        <h3 class="text-lg font-bold text-gray-700 mb-4 flex items-center gap-2">
                            <i class="fa fa-gift text-green-500"></i> Referral Activity
                        </h3>
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                            <div class="divide-y divide-gray-100" id="teamListContainer">
                                <div class="p-8 text-center text-gray-400">
                                    <div class="loader mx-auto mb-2"></div>
                                    Loading team data...
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, getCountFromServer } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDKFinkyjgys2HOO_QpRoMosGYyTFEcIgE",
            authDomain: "masterking-fa629.firebaseapp.com",
            projectId: "masterking-fa629",
            storageBucket: "masterking-fa629.firebasestorage.app",
            messagingSenderId: "680021576286",
            appId: "1:680021576286:web:52769441eeda5ab56f02cf",
            measurementId: "G-9443L8L88Q"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const usersPath = `/users`;

        let currentUser = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                loadUserProfile(user.uid);
                setupReferralLink(user.uid);
                loadTeamStats(user.uid);
                loadTeamList(user.uid);
            } else {
                window.location.href = 'account.html';
            }
        });

        async function loadUserProfile(uid) {
            try {
                const userDoc = await getDoc(doc(db, usersPath, uid));
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    document.getElementById('sidebar-user-name').innerText = data.name || currentUser.email;
                    if(data.photoURL) document.getElementById('sidebar-user-img').src = data.photoURL;
                }
            } catch (e) { console.error(e); }
        }

        // 1. GENERATE LINK
        function setupReferralLink(uid) {
            // NOTE: Replace 'account.html' with your actual registration page
            const link = `${window.location.origin}/account.html?ref=${uid}`;
            document.getElementById('referralLink').value = link;
        }

        window.copyReferral = () => {
            const copyText = document.getElementById("referralLink");
            copyText.select();
            copyText.setSelectionRange(0, 99999); 
            navigator.clipboard.writeText(copyText.value);
            alert("Referral Link Copied!");
        };

        // 2. LOAD STATS
        async function loadTeamStats(uid) {
            try {
                // Find users who have 'referredBy' == current UID
                const q = query(collection(db, usersPath), where("referredBy", "==", uid));
                
                // Count
                const snapshot = await getCountFromServer(q);
                const count = snapshot.data().count;
                document.getElementById('teamCount').innerText = count;

                // Bonus
                const userDoc = await getDoc(doc(db, usersPath, uid));
                const bonus = userDoc.data().referralBonus || 0;
                document.getElementById('bonusAmount').innerText = bonus.toLocaleString();

            } catch (e) {
                console.error("Stats error:", e);
                document.getElementById('teamCount').innerText = "0";
            }
        }

        // 3. LOAD TEAM LIST
        async function loadTeamList(uid) {
            const container = document.getElementById('teamListContainer');
            
            try {
                const q = query(collection(db, usersPath), where("referredBy", "==", uid));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="p-8 text-center">
                            <div class="bg-gray-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3 text-gray-300">
                                <i class="fa fa-user-plus text-2xl"></i>
                            </div>
                            <p class="text-gray-500 font-bold">No team members yet.</p>
                            <p class="text-xs text-gray-400 mt-1">Share your link to start building your team!</p>
                        </div>`;
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const member = doc.data();
                    const joinDate = member.createdAt ? new Date(member.createdAt.seconds * 1000).toLocaleDateString() : 'N/A';
                    // Random ID for display if name is generic
                    const displayId = doc.id.substring(0, 6).toUpperCase(); 
                    
                    html += `
                    <div class="p-4 flex items-center justify-between hover:bg-gray-50 transition-colors group">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center font-bold text-lg border-2 border-white shadow-sm">
                                <i class="fa fa-gift"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800 text-sm">Referral Bonus</h4>
                                <p class="text-[10px] text-gray-400">User ID: ${displayId}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <button class="bg-blue-500 text-white text-[10px] font-bold px-4 py-1.5 rounded-lg shadow-sm hover:bg-blue-600 transition-colors">
                                Waiting
                            </button>
                        </div>
                    </div>`;
                });
                container.innerHTML = html;

            } catch (e) {
                console.error(e);
                container.innerHTML = '<div class="p-6 text-center text-red-400">Error loading data.</div>';
            }
        };

    </script>
</body>
</html>