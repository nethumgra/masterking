<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutu Reseller | Rose Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        'sidebar-dark': '#0f172a',
                        'rose-primary': '#e11d48',
                        'rose-light': '#fff1f2',
                        'rose-dark': '#be123c',
                    }
                }
            }
        }
    </script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .drawer-content { transform: translateX(100%); transition: transform 0.3s ease-in-out; }
        .drawer-open .drawer-content { transform: translateX(0); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #e11d48; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-slide-up { animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body class="bg-rose-light text-gray-800 font-sans antialiased overflow-hidden">

    <div class="flex h-screen">

        <!-- Sidebar -->
        <aside class="w-64 bg-sidebar-dark text-white hidden md:flex flex-col flex-shrink-0 transition-all duration-300 shadow-xl" id="sidebar">
            <div class="p-6 flex items-center gap-3 border-b border-gray-700">
                <img id="sidebar-user-img" src="https://via.placeholder.com/50" alt="User" class="w-12 h-12 rounded-full border-2 border-rose-primary object-cover">
                <div>
                    <h4 id="sidebar-user-name" class="font-bold text-sm">Loading...</h4>
                    <span class="text-[10px] bg-rose-primary/20 text-rose-400 px-2 py-0.5 rounded-full border border-rose-primary/30">Reseller</span>
                </div>
            </div>

            <nav class="flex-1 overflow-y-auto px-3 space-y-2 text-sm font-medium py-6">
                <a href="reseller-dashboard.html" class="flex items-center gap-3 px-4 py-3 text-gray-300 hover:bg-white/5 hover:text-white rounded-xl transition-colors">
                    <i class="fa fa-th-large w-5"></i> Dashboard
                </a>
                <a href="#" class="flex items-center gap-3 px-4 py-3 bg-gradient-to-r from-rose-primary to-rose-dark text-white rounded-xl shadow-lg shadow-rose-900/50">
                    <i class="fa fa-store w-5"></i> Marketplace
                </a>
                <a href="reseller-orders.html" class="flex items-center gap-3 px-4 py-3 text-gray-300 hover:bg-white/5 hover:text-white rounded-xl transition-colors">
                    <i class="fa fa-box-open w-5"></i> Reseller Orders
                </a>
                <a href="reseller-team.html" class="flex items-center gap-3 px-4 py-3 text-gray-300 hover:bg-white/5 hover:text-white rounded-xl transition-colors">
                    <i class="fa fa-users w-5"></i> My Team
                </a>
                <a href="reseller-profile.html" class="flex items-center gap-3 px-4 py-3 text-gray-300 hover:bg-white/5 hover:text-white rounded-xl transition-colors">
                    <i class="fa fa-user-circle w-5"></i> Profile
                </a>
                <a href="index.html" class="flex items-center gap-3 px-4 py-3 text-rose-400 hover:bg-rose-500/10 hover:text-white rounded-xl transition-colors mb-2 border border-rose-500/20">
                    <i class="fa fa-home w-5"></i> Back to Home
                </a>
            </nav>

            <div class="p-4 border-t border-gray-700">
                <button onclick="toggleCart()" class="w-full bg-white text-rose-primary hover:bg-gray-100 font-bold py-3 rounded-xl flex items-center justify-center gap-2 transition-transform active:scale-95 shadow-lg">
                    <i class="fa fa-shopping-bag"></i> My Cart
                    <span id="sidebar-cart-count" class="bg-rose-primary text-white text-xs font-bold px-2 py-0.5 rounded-full">0</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
            
            <!-- Mobile Header -->
            <header class="bg-white shadow-sm p-4 flex justify-between items-center md:hidden z-10 shrink-0">
                <div class="flex items-center gap-3">
                    <button onclick="document.getElementById('sidebar').classList.toggle('hidden'); document.getElementById('sidebar').classList.toggle('absolute'); document.getElementById('sidebar').classList.toggle('z-50'); document.getElementById('sidebar').classList.toggle('h-full');" class="text-gray-600 text-xl">
                        <i class="fa fa-bars"></i>
                    </button>
                    <a href="reseller-dashboard.html" class="text-gray-400"><i class="fa fa-arrow-left"></i></a>
                </div>
                <h1 class="font-bold text-xl text-rose-primary">Tutu<span class="text-gray-700">Resell</span></h1>
                <button onclick="toggleCart()" class="relative text-gray-600 text-xl">
                    <i class="fa fa-shopping-bag"></i>
                    <span id="mobile-cart-badge" class="absolute -top-2 -right-2 bg-rose-primary text-white text-xs w-5 h-5 flex items-center justify-center rounded-full">0</span>
                </button>


            </header>

            <!-- Search & Filters -->
            <div class="bg-white px-5 py-4 shadow-sm z-10 shrink-0 border-b border-rose-100">
                <div class="flex items-center gap-3 mb-4">
                    <a href="index.html" class="hidden md:flex bg-sidebar-dark text-white w-10 h-10 items-center justify-center rounded-xl hover:bg-black transition-colors" title="Go to Main Shop">
        <i class="fa fa-home"></i>
    </a>
    
                    <a href="reseller-dashboard.html" class="hidden md:flex bg-rose-50 text-rose-500 w-10 h-10 items-center justify-center rounded-xl hover:bg-rose-100 transition-colors" title="Back to Dashboard">
                        <i class="fa fa-arrow-left"></i>
                    </a>
                    <div class="relative flex-1">
                        <input type="text" id="searchInput" placeholder="Search products..." class="w-full bg-rose-50 text-sm text-gray-700 rounded-xl pl-11 pr-4 py-3 focus:outline-none focus:ring-2 focus:ring-rose-primary/30 transition-all placeholder-gray-400">
                        <i class="fa fa-search absolute left-4 top-3.5 text-rose-300"></i>
                    </div>
                </div>
                
                <div class="cat-scroll flex gap-2 overflow-x-auto no-scrollbar pb-1" id="categoryContainer">
                    <button class="cat-btn bg-sidebar-dark text-white px-5 py-1.5 rounded-full text-xs font-medium whitespace-nowrap transition-colors shadow-sm" data-cat="all" onclick="filterCategory('all', this)">All Items</button>
                </div>
            </div>

            <!-- Product Grid -->
            <div id="scrollContainer" class="flex-1 overflow-y-auto p-4 md:p-6 bg-rose-light/50">
                <div id="products-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                    <!-- Products inject here -->
                </div>
                
                <div id="loadMoreSpinner" class="hidden py-8 flex justify-center w-full">
                    <div class="loader"></div>
                </div>
                <div id="endOfResults" class="hidden py-8 text-center text-gray-400 text-sm w-full font-medium tracking-wide">
                    — YOU'VE SEEN EVERYTHING —
                </div>
            </div>
        </main>
    </div>

    <!-- Product Details Modal -->
    <div id="productModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-sidebar-dark/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="absolute bottom-0 md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:bottom-auto w-full md:w-[850px] h-[90vh] md:h-auto bg-white md:rounded-2xl rounded-t-3xl shadow-2xl flex flex-col overflow-hidden animate-slide-up border-t-4 border-rose-primary">
            
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-white">
                <h3 class="font-bold text-gray-800 text-lg">Product Details</h3>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-rose-100 text-gray-500 hover:text-rose-500 flex items-center justify-center transition-colors">
                    <i class="fa fa-times"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-5">
                <div class="flex flex-col md:flex-row gap-8">
                    <div class="md:w-5/12">
                        <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100 flex items-center justify-center h-72 relative overflow-hidden group">
                            <img id="modalImg" src="" class="max-h-full max-w-full object-contain mix-blend-multiply transition-transform duration-500 group-hover:scale-110">
                            <span id="modalWeightBadge" class="absolute top-3 left-3 bg-sidebar-dark text-white text-[10px] font-bold px-2 py-1 rounded shadow-lg"></span>
                        </div>
                    </div>
                    <div class="md:w-7/12 space-y-5">
                        <div class="flex justify-between items-start gap-4">
                            <h2 id="modalTitle" class="text-2xl font-bold text-gray-800 leading-tight"></h2>
                            <button onclick="copyTitle()" class="text-gray-400 hover:text-rose-primary p-2 bg-gray-50 rounded-lg shrink-0 transition-colors" title="Copy Name">
                                <i class="fa fa-copy"></i>
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3">
                            <div class="bg-rose-50 p-3 rounded-xl border border-rose-100">
                                <p class="text-[9px] text-rose-500 font-bold uppercase tracking-wider mb-1">Wholesale</p>
                                <p class="text-lg font-extrabold text-rose-700">LKR <span id="modalBasePrice">0</span></p>
                            </div>
                            <div class="bg-green-50 p-3 rounded-xl border border-green-100">
                                <p class="text-[9px] text-green-500 font-bold uppercase tracking-wider mb-1">Market Price</p>
                                <p class="text-lg font-extrabold text-green-700">LKR <span id="modalResellPrice">0</span></p>
                            </div>
                            <div class="bg-blue-50 p-3 rounded-xl border border-blue-100">
                                <p class="text-[9px] text-blue-500 font-bold uppercase tracking-wider mb-1">Delivery</p>
                                <p class="text-lg font-bold text-blue-700">LKR <span id="modalDeliveryCost">0</span></p>
                            </div>
                        </div>

                      <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 relative group">
    <p class="text-[10px] font-bold text-gray-400 uppercase mb-1">Description</p>
    <p id="modalDesc" class="text-sm text-gray-600 leading-relaxed line-clamp-3"></p>
    <button onclick="copyDesc()" class="absolute top-3 right-3 text-xs text-rose-500 font-bold opacity-0 group-hover:opacity-100 transition-opacity bg-white px-2 py-1 rounded shadow-sm border border-rose-100">Copy</button>
</div>

<div id="modalVariationsContainer" class="space-y-4">
    </div>

                        <div class="bg-gradient-to-br from-gray-50 to-white p-5 rounded-xl border border-rose-100 shadow-sm">
                            <h4 class="text-sm font-bold text-gray-700 mb-4 flex items-center gap-2">
                                <i class="fa fa-calculator text-rose-400"></i> Profit Calculator
                            </h4>
                            <div class="flex items-center gap-4">
                                <div class="w-1/3">
                                    <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">Quantity</label>
                                    <input type="number" id="modalQty" value="1" min="1" oninput="calcModalProfit()" class="w-full bg-white border border-gray-200 rounded-lg p-2.5 text-center font-bold text-gray-700 focus:ring-2 focus:ring-rose-200 outline-none">
                                </div>
                                <div class="w-2/3">
                                    <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">Your Selling Price (Item Only)</label>
                                    <div class="relative">
                                        <span class="absolute left-3 top-2.5 text-gray-400 text-sm">Rs.</span>
                                        <input type="number" id="modalSellingPrice" placeholder="0.00" oninput="calcModalProfit()" class="w-full bg-white border-2 border-rose-200 rounded-lg p-2.5 pl-10 font-bold text-gray-800 focus:border-rose-500 focus:ring-0 outline-none">
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 flex justify-between items-center bg-green-50 px-4 py-3 rounded-xl border border-green-100">
                                <span class="text-xs font-bold text-green-700">Your Net Profit:</span>
                                <span class="text-xl font-extrabold text-green-600">LKR <span id="modalProfitDisplay">0</span></span>
                            </div>
                            <p class="text-[10px] text-gray-400 mt-2 text-center">*Client pays: Item Price + Delivery Fee</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-5 border-t bg-gray-50">
                <button onclick="addToCartReal()" id="addToCartBtn" class="w-full bg-gradient-to-r from-rose-primary to-rose-dark hover:from-rose-600 hover:to-rose-800 text-white font-bold py-4 rounded-xl shadow-lg shadow-rose-200 transition-all transform active:scale-[0.99] flex justify-center items-center gap-2">
                    ADD TO CART <i class="fa fa-cart-plus"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Cart Drawer (Kept as is) -->
    <div id="cartDrawer" class="fixed inset-0 z-50 pointer-events-none">
        <div id="cartOverlay" onclick="toggleCart()" class="drawer-overlay absolute inset-0 opacity-0 pointer-events-none bg-sidebar-dark/50 transition-opacity duration-300"></div>
        <div id="cartContent" class="drawer-content absolute top-0 right-0 h-full w-full md:w-[500px] bg-white shadow-2xl flex flex-col pointer-events-auto">
            
            <div class="p-5 border-b flex justify-between items-center bg-white shrink-0">
                <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                    <span class="bg-rose-100 text-rose-600 w-8 h-8 rounded-full flex items-center justify-center"><i class="fa fa-shopping-bag text-sm"></i></span>
                    Your Resell Cart
                </h3>
                <button onclick="toggleCart()" class="text-gray-400 hover:text-rose-500 transition-colors">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-5 space-y-6 bg-rose-50/30">
                <div id="cartItemsContainer" class="space-y-4">
                    <p class="text-center text-gray-400 py-10">Cart is empty...</p>
                </div>

                <div id="checkoutForm" class="hidden border-t border-dashed border-gray-300 pt-6">
                    <div class="mb-6">
                        <button onclick="generateCustomerInvoice()" class="w-full bg-white border-2 border-blue-100 text-blue-600 font-bold py-3 rounded-xl hover:bg-blue-50 transition-colors flex items-center justify-center gap-2 shadow-sm">
                            <i class="fa fa-file-invoice"></i> Generate Customer Slip
                        </button>
                    </div>

                    <h4 class="font-bold text-gray-700 mb-3 text-sm uppercase tracking-wide">Delivery Details</h4>
                    <div class="space-y-3 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <input type="text" id="custName" placeholder="Customer Name" class="w-full border-b border-gray-200 p-2 text-sm outline-none focus:border-rose-400 transition-colors">
                        <input type="tel" id="custPhone" placeholder="Phone Number" class="w-full border-b border-gray-200 p-2 text-sm outline-none focus:border-rose-400 transition-colors">
                        <textarea id="custAddress" placeholder="Full Delivery Address" rows="2" class="w-full border-b border-gray-200 p-2 text-sm outline-none focus:border-rose-400 transition-colors resize-none"></textarea>
                    </div>

                    <h4 class="font-bold text-gray-700 mt-6 mb-3 text-sm uppercase tracking-wide">Payment Method</h4>
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <label class="cursor-pointer group">
                            <input type="radio" name="payment" value="cod" class="peer hidden" checked onchange="handlePaymentChange()">
                            <div class="bg-white border-2 border-gray-100 peer-checked:border-rose-500 peer-checked:bg-rose-50 peer-checked:text-rose-700 rounded-xl p-3 text-center transition-all hover:border-rose-200 h-full flex flex-col items-center justify-center">
                                <i class="fa fa-truck mb-1"></i> 
                                <span class="text-[10px] font-bold">COD</span>
                            </div>
                        </label>
                        <label class="cursor-pointer group">
                            <input type="radio" name="payment" value="bank_transfer" class="peer hidden" onchange="handlePaymentChange()">
                            <div class="bg-white border-2 border-gray-100 peer-checked:border-rose-500 peer-checked:bg-rose-50 peer-checked:text-rose-700 rounded-xl p-3 text-center transition-all hover:border-rose-200 h-full flex flex-col items-center justify-center">
                                <i class="fa fa-university mb-1"></i> 
                                <span class="text-[10px] font-bold">Bank</span>
                            </div>
                        </label>
                        <label class="cursor-pointer group">
                            <input type="radio" name="payment" value="store_pickup" class="peer hidden" onchange="handlePaymentChange()">
                            <div class="bg-white border-2 border-gray-100 peer-checked:border-rose-500 peer-checked:bg-rose-50 peer-checked:text-rose-700 rounded-xl p-3 text-center transition-all hover:border-rose-200 h-full flex flex-col items-center justify-center">
                                <i class="fa fa-store mb-1"></i> 
                                <span class="text-[10px] font-bold">Pickup</span>
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <div id="cartFooter" class="p-5 bg-white border-t shadow-[0_-5px_20px_rgba(0,0,0,0.05)] hidden shrink-0 z-10">
                <div class="space-y-2 mb-4 text-sm">
                    <div class="flex justify-between text-gray-500">
                        <span>Items Total:</span>
                        <span>LKR <span id="cartItemsTotal">0</span></span>
                    </div>
                     <div class="flex justify-between text-blue-600">
                        <span>Delivery Fee:</span>
                        <span id="deliveryFeeDisplay" class="font-bold">Rs. 0</span>
                    </div>
                    <div class="flex justify-between font-bold text-green-600 text-base bg-green-50 p-2 rounded-lg border border-green-100">
                        <span>Your Total Profit:</span>
                        <span>Rs. <span id="cartProfitTotal">0</span></span>
                    </div>
                    <div class="flex justify-between font-extrabold text-gray-800 text-lg pt-2 border-t border-gray-100">
                        <span>Final Bill:</span>
                        <span>Rs. <span id="cartGrandTotal">0</span></span>
                    </div>
                </div>
                <button onclick="placeOrderReal()" id="placeOrderBtn" class="w-full bg-sidebar-dark hover:bg-gray-900 text-white font-bold py-4 rounded-xl shadow-xl flex justify-center items-center gap-2 transition-all transform active:scale-[0.98]">
                    CONFIRM ORDER <i class="fa fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Invoice Modal (Slip Download) -->
    <div id="invoiceModal" class="fixed inset-0 z-[70] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-sidebar-dark/80 backdrop-blur-sm" onclick="document.getElementById('invoiceModal').classList.add('hidden')"></div>
        <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl relative z-10 overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-rose-600 p-4 text-white flex justify-between items-center">
                <h3 class="font-bold text-sm">Customer Bill Slip</h3>
                <button onclick="document.getElementById('invoiceModal').classList.add('hidden')" class="text-white hover:text-gray-200"><i class="fa fa-times"></i></button>
            </div>
            <div class="overflow-y-auto p-4 bg-gray-100 flex justify-center">
                <div id="invoiceContent" class="bg-white p-6 w-full shadow-md rounded-lg border border-gray-200">
                    <div class="text-center border-b-2 border-gray-100 pb-4 mb-4">
                        <h2 class="text-2xl font-black text-rose-600 tracking-tight">INVOICE</h2>
                        <p class="text-[10px] text-gray-400 mt-1" id="invDate">Date: ...</p>
                    </div>
                    <div class="space-y-3 text-sm mb-6" id="invItems"></div>
                    <div class="border-t-2 border-gray-100 pt-4">
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-gray-600 text-xs">Total Amount</span>
                            <span class="font-black text-xl text-gray-800">LKR <span id="invTotal">0</span></span>
                        </div>
                    </div>
                    <div class="mt-8 text-center"><p class="text-[9px] text-gray-400">Powered by Tutu Resell</p></div>
                </div>
            </div>
            <div class="p-4 bg-white border-t border-gray-100 flex gap-3">
                <button onclick="downloadInvoice()" class="flex-1 bg-rose-600 hover:bg-rose-700 text-white font-bold py-3 rounded-xl text-xs transition-colors flex items-center justify-center gap-2">
                    <i class="fa fa-download"></i> Save as Image
                </button>
            </div>
        </div>
    </div>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, getDoc, onSnapshot, setDoc, updateDoc, deleteDoc, increment, serverTimestamp, writeBatch, query, where, limit, startAfter, orderBy, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDKFinkyjgys2HOO_QpRoMosGYyTFEcIgE",
        authDomain: "masterking-fa629.firebaseapp.com",
        projectId: "masterking-fa629",
        storageBucket: "masterking-fa629.firebasestorage.app",
        messagingSenderId: "680021576286",
        appId: "1:680021576286:web:52769441eeda5ab56f02cf",
        measurementId: "G-9443L8L88Q"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    const appId = 'default-app-id';
    const publicDataPath = `/artifacts/${appId}/public/data`;
    const usersPath = `/users`;

    let currentUser = null;
    let currentModalProduct = {};
    let currentCartData = [];
    let lastVisibleProduct = null;
    let isProductsLoading = false;
    let hasMoreProducts = true;
    let currentCategory = 'all';
    let searchQuery = '';
    let searchTimeout = null;

    let productsCache = {}; 
    let selectedVars = {}; 
    let currentVarPrices = {}; // තෝරාගන්නා variations වල මිල තියාගන්න

    let finalCartWeight = 0;
    let finalDeliveryFee = 0;
    let finalGrandTotal = 0;

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            loadUserProfile(user.uid);
            loadCategories();
            loadProducts(true);
            listenToCart(user.uid);
        } else {
            window.location.href = 'account.html';
        }
    });

    async function loadUserProfile(uid) {
        try {
            const userDoc = await getDoc(doc(db, usersPath, uid));
            if (userDoc.exists()) {
                const data = userDoc.data();
                document.getElementById('sidebar-user-name').innerText = data.name || "Reseller User";
                if(data.photoURL) document.getElementById('sidebar-user-img').src = data.photoURL;
            }
        } catch (e) { console.error(e); }
    }

    async function loadCategories() {
        const container = document.getElementById('categoryContainer');
        try {
            const snap = await getDocs(collection(db, publicDataPath, 'categories'));
            snap.forEach(docSnap => {
                const cat = docSnap.data();
                const btn = document.createElement('button');
                btn.className = `cat-btn bg-white border border-rose-100 text-gray-500 px-5 py-1.5 rounded-full text-xs font-medium whitespace-nowrap hover:bg-rose-50 hover:text-rose-600 transition-colors shadow-sm`;
                btn.innerText = cat.name;
                btn.onclick = () => filterCategory(cat.name, btn);
                container.appendChild(btn);
            });
        } catch (e) { console.error(e); }
    }

    window.filterCategory = (catName, btnElement) => {
        document.querySelectorAll('.cat-btn').forEach(b => {
            b.className = `cat-btn bg-white border border-rose-100 text-gray-500 px-5 py-1.5 rounded-full text-xs font-medium whitespace-nowrap hover:bg-rose-50 hover:text-rose-600 transition-colors shadow-sm`;
        });
        btnElement.className = `cat-btn bg-sidebar-dark border border-sidebar-dark text-white px-5 py-1.5 rounded-full text-xs font-medium whitespace-nowrap transition-colors shadow-md`;
        currentCategory = catName;
        loadProducts(true);
    };

    // --- 1. LOAD PRODUCTS (Updated: Resell -> Wholesale, Price -> Market) ---
    async function loadProducts(reset = false) {
        if (isProductsLoading || (!hasMoreProducts && !reset)) return;
        isProductsLoading = true;
        document.getElementById('loadMoreSpinner').classList.remove('hidden');
        const container = document.getElementById('products-grid');

        if (reset) {
            container.innerHTML = '';
            lastVisibleProduct = null;
            hasMoreProducts = true;
            document.getElementById('endOfResults').classList.add('hidden');
        }

        try {
            let q = query(collection(db, publicDataPath, 'products'), orderBy('createdAt', 'desc'), limit(15));
            if (currentCategory !== 'all') q = query(q, where('category', '==', currentCategory));
            if (lastVisibleProduct) q = query(q, startAfter(lastVisibleProduct));

            const snapshot = await getDocs(q);
            if (snapshot.empty) {
                hasMoreProducts = false;
                document.getElementById('endOfResults').classList.remove('hidden');
            } else {
                lastVisibleProduct = snapshot.docs[snapshot.docs.length - 1];
                snapshot.forEach(docSnap => {
                    const p = docSnap.data();
                    const pid = docSnap.id;
                    productsCache[pid] = p;

                    if (searchQuery && !p.name.toLowerCase().includes(searchQuery)) return;

                    // FIX: මිල ගණන් මාරු කළා (Resell -> Wholesale, Price -> Market)
                    const wholesalePrice = parseFloat(p.resellPrice) || 0; 
                    const marketPrice = parseFloat(p.price) || wholesalePrice;
                    const weight = parseFloat(p.weight) || 0;

                    const card = `
                    <div class="bg-white rounded-2xl shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all overflow-hidden border border-rose-50 flex flex-col h-full group relative">
                        <div class="absolute top-2 right-2 z-10 bg-black/60 text-white text-[9px] px-1.5 py-0.5 rounded backdrop-blur-sm font-bold">${weight} KG</div>
                        <div class="relative aspect-square bg-gray-50 overflow-hidden">
                             <img src="${p.imageUrl || 'https://via.placeholder.com/300'}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                        </div>
                        <div class="p-3 flex flex-col flex-grow">
                            <h3 class="font-bold text-gray-800 text-[11px] mb-2 line-clamp-2 h-8 leading-snug">${p.name}</h3>
                            <div class="mt-auto space-y-1">
                                <div class="flex justify-between items-end">
                                    <div>
                                        <p class="text-[8px] text-gray-400 uppercase font-bold">Wholesale (Cost)</p>
                                        <p class="text-sm font-black text-rose-600">Rs. ${wholesalePrice.toLocaleString()}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-[8px] text-green-500 uppercase font-bold">Market (Sell)</p>
                                        <p class="text-sm font-black text-green-600">Rs. ${marketPrice.toLocaleString()}</p>
                                    </div>
                                </div>
                                <button onclick="openModal('${pid}')" class="w-full mt-2 bg-rose-50 hover:bg-rose-600 hover:text-white text-rose-600 text-[10px] font-bold py-2 rounded-lg transition-all border border-rose-100">
                                    SELL NOW <i class="fa fa-arrow-right text-[8px]"></i>
                                </button>
                            </div>
                        </div>
                    </div>`;
                    container.innerHTML += card;
                });
            }
        } catch (e) { console.error(e); } 
        finally {
            isProductsLoading = false;
            document.getElementById('loadMoreSpinner').classList.add('hidden');
        }
    }

    // --- 2. MODAL LOGIC (Variation Logic Integrated) ---
    window.openModal = (id) => {
        const product = productsCache[id];
        if (!product) return;

        currentModalProduct = { ...product, id };
        selectedVars = {};
        currentVarPrices = {};

        document.getElementById('modalTitle').innerText = product.name;
        document.getElementById('modalImg').src = product.imageUrl || 'https://via.placeholder.com/300';
        document.getElementById('modalDesc').innerText = product.description || '';
        document.getElementById('modalWeightBadge').innerText = `${product.weight || 0} KG`;
        document.getElementById('modalDeliveryCost').innerText = (product.deliveryPrice || 350).toLocaleString();

        const varContainer = document.getElementById('modalVariationsContainer');
        if (varContainer) {
            varContainer.innerHTML = '';
            const variations = product.variations ? (Array.isArray(product.variations) ? product.variations : Object.values(product.variations)) : [];

            variations.forEach(vGroup => {
                const groupDiv = document.createElement('div');
                groupDiv.className = "mb-4";
                groupDiv.innerHTML = `<p class="text-[10px] font-bold text-gray-400 uppercase mb-2">${vGroup.name}</p>`;
                
                const btnWrapper = document.createElement('div');
                btnWrapper.className = "flex flex-wrap gap-2";

                const options = Array.isArray(vGroup.options) ? vGroup.options : Object.values(vGroup.options);
                options.forEach((opt, idx) => {
                    const optName = typeof opt === 'object' ? (opt.name || opt.label) : opt;
                    const optPrice = typeof opt === 'object' ? (parseFloat(opt.price) || 0) : 0;

                    const btn = document.createElement('button');
                    btn.innerText = optName;
                    btn.className = `px-3 py-1.5 border rounded-lg text-xs font-medium transition-all ${idx === 0 ? 'bg-rose-600 text-white border-rose-600' : 'bg-white text-gray-500 border-gray-200'}`;
                    
                    if(idx === 0) {
                        selectedVars[vGroup.name] = optName;
                        currentVarPrices[vGroup.name] = optPrice;
                    }

                  btn.onclick = () => {
    btnWrapper.querySelectorAll('button').forEach(b => {
        b.className = "px-3 py-1.5 border rounded-lg text-xs font-medium bg-white text-gray-500 border-gray-200";
    });
    btn.className = "px-3 py-1.5 border rounded-lg text-xs font-medium bg-rose-600 text-white border-rose-600";
    
    selectedVars[vGroup.name] = optName;

    // මෙතන තමයි වැදගත්ම වෙනස - keys දෙකම object එකක් ලෙස තියාගන්නවා
    currentVarPrices[vGroup.name] = {
        wholesale: parseFloat(opt.resellPrice) || 0,
        market: parseFloat(opt.marketPrice) || 0
    };
    
    updateDynamicPrices();
};
                    btnWrapper.appendChild(btn);
                });
                groupDiv.appendChild(btnWrapper);
                varContainer.appendChild(groupDiv);
            });
        }
        updateDynamicPrices(); 
        document.getElementById('productModal').classList.remove('hidden');
    };

    // --- 3. DYNAMIC PRICE UPDATER ---
 function updateDynamicPrices() {
    // තෝරාගත් සියලු variations වල wholesale සහ market මිලවල් එකතු කිරීම
    const varWholesaleExtra = Object.values(currentVarPrices).reduce((a, b) => a + (b.wholesale || 0), 0);
    const varMarketExtra = Object.values(currentVarPrices).reduce((a, b) => a + (b.market || 0), 0);
    
    // භාණ්ඩයේ මූලික මිල ගණන් (Base prices)
    let baseWholesale = parseFloat(currentModalProduct.resellPrice) || 0;
    let baseMarket = parseFloat(currentModalProduct.price) || baseWholesale;

    // Logic: Variation එකේ මිලක් ඇත්නම් එය භාවිතා කරයි, නැතිනම් base price එක ගනී
    const finalWholesale = varWholesaleExtra > 0 ? varWholesaleExtra : baseWholesale;
    const finalMarket = varMarketExtra > 0 ? varMarketExtra : baseMarket;

    // UI එකට අගයන් ලබා දීම
    document.getElementById('modalBasePrice').innerText = finalWholesale.toLocaleString();
    document.getElementById('modalResellPrice').innerText = finalMarket.toLocaleString();
    
    // Selling Price field එක Market Price එකට default සෙට් කිරීම
    document.getElementById('modalSellingPrice').value = finalMarket;
    
    // මේක තමයි Order එක දාද්දී cost එක විදිහට යන්නේ
    currentModalProduct.currentActivePrice = finalWholesale; 
    
    calcModalProfit();
}

    window.calcModalProfit = () => {
        const selling = parseFloat(document.getElementById('modalSellingPrice').value) || 0;
        const qty = parseInt(document.getElementById('modalQty').value) || 1;
        const wholesale = currentModalProduct.currentActivePrice || 0;
        
        const profitPerUnit = selling - wholesale;
        const totalProfit = profitPerUnit * qty;
        
        const display = document.getElementById('modalProfitDisplay');
        display.innerText = totalProfit.toLocaleString();
        display.classList.toggle('text-red-600', totalProfit < 0);
        display.classList.toggle('text-green-600', totalProfit >= 0);
    };

    // --- 4. ADD TO CART ---
    window.addToCartReal = async () => {
        if (!currentUser) return;
        const sellingPrice = parseFloat(document.getElementById('modalSellingPrice').value);
        const qty = parseInt(document.getElementById('modalQty').value);
        const wholesale = currentModalProduct.currentActivePrice || 0;

        if (sellingPrice < wholesale && !confirm("Selling below cost? You will lose money.")) return;

        const btn = document.getElementById('addToCartBtn');
        btn.disabled = true;

        try {
            const varSuffix = Object.values(selectedVars).join('-').replace(/\s+/g, '');
            const cartId = currentModalProduct.id + (varSuffix ? '-' + varSuffix : '');
            
            const cartRef = doc(db, usersPath, currentUser.uid, 'cart', cartId);
            
            const data = {
                productId: currentModalProduct.id,
                name: currentModalProduct.name,
                wholesalePrice: wholesale,
                sellingPrice: sellingPrice,
                profitPerUnit: sellingPrice - wholesale,
                imageUrl: currentModalProduct.imageUrl,
                weight: currentModalProduct.weight || 0,
                variations: selectedVars,
                quantity: qty,
                addedAt: serverTimestamp()
            };
            
            await setDoc(cartRef, data, { merge: true });
            closeModal();
            toggleCart();
        } catch (e) { alert("Failed to add to cart"); }
        finally { btn.disabled = false; }
    };

    // --- 5. CART LISTENER ---
    function listenToCart(uid) {
        onSnapshot(collection(db, usersPath, uid, 'cart'), (snap) => {
            const container = document.getElementById('cartItemsContainer');
            const count = snap.size;
            document.getElementById('mobile-cart-badge').innerText = count;
            document.getElementById('sidebar-cart-count').innerText = count;

            if (snap.empty) {
                container.innerHTML = '<p class="text-center py-10 opacity-40">Cart is empty</p>';
                document.getElementById('cartFooter').classList.add('hidden');
                document.getElementById('checkoutForm').classList.add('hidden');
                return;
            }

            document.getElementById('cartFooter').classList.remove('hidden');
            document.getElementById('checkoutForm').classList.remove('hidden');
            container.innerHTML = '';
            currentCartData = [];

            let totalProfit = 0, billTotal = 0, totalWeight = 0;

            snap.forEach(docSnap => {
                const item = docSnap.data();
                const lineTotal = item.sellingPrice * item.quantity;
                const lineProfit = item.profitPerUnit * item.quantity;
                
                totalProfit += lineProfit;
                billTotal += lineTotal;
                totalWeight += (item.weight * item.quantity);
                
                currentCartData.push({...item, id: docSnap.id});

                const varString = item.variations ? Object.values(item.variations).join(' / ') : '';

                container.innerHTML += `
                <div class="bg-white border rounded-xl p-3 flex gap-3 relative group">
                    <img src="${item.imageUrl}" class="w-14 h-14 object-cover rounded-lg">
                    <div class="flex-1">
                        <h4 class="font-bold text-[10px] text-gray-800 line-clamp-1">${item.name}</h4>
                        <p class="text-[8px] text-rose-500 font-bold">${varString}</p>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-[9px] font-bold">Qty: ${item.quantity}</span>
                            <span class="text-xs font-black">Rs. ${lineTotal.toLocaleString()}</span>
                        </div>
                    </div>
                    <button onclick="removeFromCart('${docSnap.id}')" class="absolute top-2 right-2 text-gray-300 hover:text-rose-500"><i class="fa fa-trash-alt text-[10px]"></i></button>
                </div>`;
            });

            window.tempItemsTotal = billTotal;
            finalCartWeight = totalWeight;
            document.getElementById('cartItemsTotal').innerText = billTotal.toLocaleString();
            document.getElementById('cartProfitTotal').innerText = totalProfit.toLocaleString();
            handlePaymentChange();
        });
    }

    window.removeFromCart = (id) => deleteDoc(doc(db, usersPath, currentUser.uid, 'cart', id));

    window.handlePaymentChange = () => {
        const methodEl = document.querySelector('input[name="payment"]:checked');
        const method = methodEl ? methodEl.value : 'cod';
        let deliveryFee = 0;
        if (method !== 'store_pickup' && finalCartWeight > 0) {
            deliveryFee = 350 + (Math.max(0, Math.ceil(finalCartWeight - 1)) * 100);
        }
        finalDeliveryFee = deliveryFee;
        finalGrandTotal = (window.tempItemsTotal || 0) + deliveryFee;
        document.getElementById('deliveryFeeDisplay').innerText = `Rs. ${deliveryFee.toLocaleString()}`;
        document.getElementById('cartGrandTotal').innerText = finalGrandTotal.toLocaleString();
    };

    window.toggleCart = () => {
        const drawer = document.getElementById('cartDrawer');
        drawer.classList.toggle('drawer-open');
        drawer.classList.toggle('pointer-events-none');
        document.getElementById('cartOverlay').classList.toggle('opacity-0');
        document.getElementById('cartOverlay').classList.toggle('pointer-events-none');
    };

    window.placeOrderReal = async () => {
        const name = document.getElementById('custName').value;
        const phone = document.getElementById('custPhone').value;
        const address = document.getElementById('custAddress').value;
        const method = document.querySelector('input[name="payment"]:checked').value;

        if (!name || !phone || (method !== 'store_pickup' && !address)) return alert("Fill all details");

        const btn = document.getElementById('placeOrderBtn');
        btn.disabled = true;

        try {
            let wholesaleSubtotal = 0, resellerProfit = 0;
            currentCartData.forEach(d => {
                wholesaleSubtotal += (d.wholesalePrice * d.quantity);
                resellerProfit += (d.profitPerUnit * d.quantity);
            });

            const orderData = {
                resellerId: currentUser.uid,
                resellerEmail: currentUser.email,
                customer: { name, phone, address },
                items: currentCartData,
                method,
                financials: { wholesaleSubtotal, resellerProfit, delivery: finalDeliveryFee, grandTotal: finalGrandTotal },
                status: 'Pending',
                createdAt: serverTimestamp()
            };

            await addDoc(collection(db, 'reseller_orders'), orderData);
            const batch = writeBatch(db);
            currentCartData.forEach(item => batch.delete(doc(db, usersPath, currentUser.uid, 'cart', item.id)));
            await batch.commit();
            alert("Order Placed!");
            toggleCart();
        } catch(e) { console.error(e); }
        finally { btn.disabled = false; }
    };

    // Helper functions
    window.closeModal = () => document.getElementById('productModal').classList.add('hidden');
    window.copyTitle = () => { navigator.clipboard.writeText(currentModalProduct.name); alert("Copied"); };
    window.copyDesc = () => { navigator.clipboard.writeText(currentModalProduct.description); alert("Copied"); };
    
    // --- Invoice Generation ---
    window.generateCustomerInvoice = () => {
        const invItems = document.getElementById('invItems');
        invItems.innerHTML = '';
        currentCartData.forEach(item => {
            const varInfo = item.variations ? ` (${Object.values(item.variations).join('/')})` : '';
            invItems.innerHTML += `
                <div class="flex justify-between border-b border-dashed py-2 text-[10px]">
                    <span>${item.name}${varInfo} x${item.quantity}</span>
                    <span class="font-bold">${(item.sellingPrice * item.quantity).toLocaleString()}</span>
                </div>`;
        });
        if(finalDeliveryFee > 0) invItems.innerHTML += `<div class="flex justify-between py-1 text-[10px]"><span>Delivery</span><span>${finalDeliveryFee.toLocaleString()}</span></div>`;
        document.getElementById('invTotal').innerText = finalGrandTotal.toLocaleString();
        document.getElementById('invDate').innerText = new Date().toLocaleDateString();
        document.getElementById('invoiceModal').classList.remove('hidden');
    };

    window.downloadInvoice = () => {
        html2canvas(document.getElementById('invoiceContent')).then(canvas => {
            const link = document.createElement('a');
            link.download = `bill-${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        });
    };

    // Global listeners
    document.getElementById('scrollContainer').addEventListener('scroll', (e) => {
        if (e.target.scrollTop + e.target.clientHeight >= e.target.scrollHeight - 50) loadProducts();
    });
    document.getElementById('searchInput').addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchQuery = e.target.value.toLowerCase();
        searchTimeout = setTimeout(() => loadProducts(true), 500);
    });

</script>
</body>
</html>