<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details - Pink Store</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                    colors: {
                        'mudalali-green': {
                            light: '#fbcfe8',
                            DEFAULT: '#db2777', // Modern Pinkish-Red
                            dark: '#be185d',
                            900: '#831843'
                        },
                        'mm-gray': { 50: '#f9fafb', 100: '#f3f4f6', 200: '#e5e7eb', 500: '#6b7280', 800: '#1f2937' }
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer base {
            body { @apply font-sans text-gray-800 bg-white selection:bg-mudalali-green selection:text-white; }
        }
        @layer components {
            .drawer-overlay { @apply fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] transition-opacity duration-300 opacity-0 pointer-events-none; }
            .drawer-content { @apply fixed top-0 right-0 h-full bg-white shadow-2xl z-[101] transform translate-x-full transition-transform duration-500 ease-in-out w-[90%] max-w-[450px]; }
            .drawer.open .drawer-overlay { @apply opacity-100 pointer-events-auto; }
            .drawer.open .drawer-content { @apply transform translate-x-0; }
            
            .btn-primary { @apply bg-mudalali-green text-white py-4 px-8 rounded-2xl font-bold shadow-lg hover:bg-mudalali-green-dark transition-all active:scale-95 flex items-center justify-center gap-2 disabled:opacity-50; }
            .btn-secondary { @apply bg-white border-2 border-mudalali-green text-mudalali-green py-4 px-8 rounded-2xl font-bold hover:bg-pink-50 transition-all active:scale-95 flex items-center justify-center gap-2; }
            
            .variation-btn { @apply px-5 py-2.5 border-2 border-gray-100 rounded-xl text-sm font-bold transition-all duration-200 hover:border-pink-200 bg-white text-gray-600 cursor-pointer; }
            .variation-btn.active { @apply border-mudalali-green bg-pink-50 text-mudalali-green ring-1 ring-mudalali-green shadow-sm; }
            
            .page-tab-btn { @apply flex-1 text-center py-4 font-bold text-gray-400 border-b-4 border-transparent transition-all cursor-pointer; }
            .page-tab-btn.active { @apply text-mudalali-green border-mudalali-green bg-pink-50/30; }

            .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #f7f7f7 50%, #f0f0f0 75%); background-size: 200% 100%; animation: skeleton-loading 1.5s infinite; }
            @keyframes skeleton-loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
            
            .rating-stars .star { @apply text-gray-300 cursor-pointer text-2xl transition-colors; }
            .rating-stars .star.selected { @apply text-yellow-400; }
        }
    </style>
</head>
<body class="pb-20 md:pb-0">

    <div id="page-loader" class="fixed top-0 left-0 h-1 bg-mudalali-green z-[200] transition-all duration-300" style="width: 0%;"></div>

    <header class="bg-white sticky top-0 z-[90] border-b border-pink-100 shadow-sm">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center gap-4">
             <a href="index.html" id="mobile-logo-link" class="flex items-center">
    <img src="logo.png" alt="Logo" class="h-8 w-auto object-contain">
</a>
            <div class="flex-grow max-w-xl hidden md:block">
                <div class="relative">
                    <input type="text" placeholder="Search products..." class="w-full px-6 py-2.5 border rounded-full bg-gray-50 text-sm focus:outline-pink-200">
                    <i class="fa fa-search absolute right-5 top-3.5 text-gray-400"></i>
                </div>
            </div>
            <div class="flex items-center space-x-6">
                <a href="account.html" class="text-gray-500 hover:text-mudalali-green flex flex-col items-center">
                    <i class="fa-regular fa-user text-xl"></i>
                    <span class="text-[9px] font-bold uppercase mt-1">Account</span>
                </a>
                <button id="cart-drawer-btn" class="relative text-gray-500 hover:text-mudalali-green flex flex-col items-center">
                    <i class="fa-solid fa-cart-shopping text-xl"></i>
                    <span id="cart-count-badge" class="absolute -top-2 -right-2 bg-mudalali-green text-white text-[10px] w-5 h-5 rounded-full flex items-center justify-center border-2 border-white font-bold">0</span>
                    <span class="text-[9px] font-bold uppercase mt-1">Cart</span>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div id="product-skeleton" class="w-full">
            <div class="grid lg:grid-cols-2 gap-12">
                <div class="aspect-square skeleton rounded-[2.5rem]"></div>
                <div class="space-y-6">
                    <div class="h-12 w-3/4 skeleton rounded-xl"></div>
                    <div class="h-8 w-1/4 skeleton rounded-xl"></div>
                    <div class="h-40 w-full skeleton rounded-xl"></div>
                </div>
            </div>
        </div>

        

            <div class="grid lg:grid-cols-3 gap-12">
                <div class="lg:col-span-2 space-y-10">
                    <div class="grid lg:grid-cols-2 gap-10">
                        <div class="sticky top-28 h-fit">
                            <div class="bg-gray-50 rounded-[2.5rem] p-6 mb-4">
                                <img id="main-product-image" class="w-full h-auto mix-blend-multiply rounded-2xl transition-transform hover:scale-105 duration-500">
                            </div>
                        </div>

                        <div class="flex flex-col">
                            <h1 id="product-name" class="text-3xl md:text-4xl font-black text-gray-900 leading-tight mb-4">...</h1>
                            
                            <div id="product-price-container" class="mb-8">
                                <span class="text-4xl font-black text-mudalali-green">Rs. 0.00</span>
                            </div>

                            <div id="product-variations" class="space-y-6 mb-8">
                                </div>

                            <div class="mb-10">
                                <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest block mb-3">Select Quantity</label>
                                <div class="flex items-center bg-gray-100 w-fit rounded-2xl p-1.5">
                                    <button id="qty-minus" class="w-10 h-10 rounded-xl hover:bg-white transition-all shadow-sm"><i class="fa fa-minus text-xs"></i></button>
                                    <input type="number" id="qty-input" value="1" readonly class="bg-transparent w-12 text-center font-bold text-lg">
                                    <button id="qty-plus" class="w-10 h-10 rounded-xl hover:bg-white transition-all shadow-sm"><i class="fa fa-plus text-xs"></i></button>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <button id="add-to-cart-btn" class="btn-secondary">Add to Cart</button>
                                <button id="buy-now-btn" class="btn-primary">Buy Now</button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-[2rem] border border-gray-100 overflow-hidden shadow-sm">
                        <div class="flex bg-gray-50/50 border-b">
                            <button id="desc-tab-btn" class="page-tab-btn active">Description</button>
                            <button id="delivery-tab-btn" class="page-tab-btn">Delivery</button>
                            <button id="reviews-tab-btn" class="page-tab-btn">Reviews</button>
                        </div>
                        <div class="p-8">
                            <div id="desc-tab-panel" class="text-gray-600 leading-relaxed text-sm md:text-base">
                                <div id="product-description"></div>
                            </div>
                            <div id="delivery-tab-panel" class="hidden text-gray-600 space-y-4">
                                <div id="product-delivery"></div>
                            </div>
                            <div id="reviews-tab-panel" class="hidden">
                                <div id="review-form-container" class="mb-8 p-6 bg-pink-50 rounded-2xl hidden">
                                    <h3 class="font-bold mb-4">Share your feedback</h3>
                                    <form id="review-form" class="space-y-4">
                                        <div class="rating-stars flex gap-2 mb-2">
                                            <i class="star fa fa-star" data-value="1"></i>
                                            <i class="star fa fa-star" data-value="2"></i>
                                            <i class="star fa fa-star" data-value="3"></i>
                                            <i class="star fa fa-star" data-value="4"></i>
                                            <i class="star fa fa-star" data-value="5"></i>
                                        </div>
                                        <textarea id="review-text" class="w-full p-4 border-none rounded-xl bg-white text-sm focus:ring-2 focus:ring-mudalali-green" rows="3" placeholder="What did you think about this product?"></textarea>
                                        <button type="submit" class="btn-primary py-2.5 px-6 text-sm">Post Review</button>
                                    </form>
                                </div>
                                <div id="reviews-list" class="space-y-4"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-1">
                    <div class="bg-white rounded-[2rem] p-6 border border-gray-100 shadow-sm sticky top-28">
                        <h3 class="font-bold mb-6 border-l-4 border-mudalali-green pl-3">More for You</h3>
                        <div id="related-products-grid" class="space-y-4">
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="cart-drawer" class="drawer">
        <div class="drawer-overlay" id="cart-overlay"></div>
        <div class="drawer-content p-8 flex flex-col rounded-l-[2.5rem]">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-black">Bag <span class="text-mudalali-green">.</span></h2>
                <button id="close-cart" class="text-3xl hover:rotate-90 transition-transform">&times;</button>
            </div>
            <div id="cart-items-container" class="flex-grow space-y-4 overflow-y-auto pr-2">
                </div>
            <div class="pt-8 border-t mt-6">
                <div class="flex justify-between font-bold text-xl mb-6 px-2">
                    <span>Subtotal</span>
                    <span id="cart-total-price" class="text-mudalali-green">Rs. 0.00</span>
                </div>
                <a href="checkout.html" class="btn-primary w-full uppercase tracking-widest text-sm py-5">Secure Checkout</a>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, getDocs, collection, onSnapshot, query, where, orderBy, limit, setDoc, deleteDoc, addDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDKFinkyjgys2HOO_QpRoMosGYyTFEcIgE",
            authDomain: "masterking-fa629.firebaseapp.com",
            projectId: "masterking-fa629",
            storageBucket: "masterking-fa629.firebasestorage.app",
            messagingSenderId: "680021576286",
            appId: "1:680021576286:web:52769441eeda5ab56f02cf"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        let productData = null;
        let selectedVars = {};
        let quantity = 1;

        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        // --- CORE FUNCTIONS ---

        async function initProductPage() {
            if (!productId) return window.location.href = 'shop.html';
            updateProgress(30);

            try {
                const docSnap = await getDoc(doc(db, '/artifacts/default-app-id/public/data/products', productId));
                if (!docSnap.exists()) return window.location.href = 'shop.html';

                productData = { id: docSnap.id, ...docSnap.data() };
                renderProductUI();
                
                loadSellerData(productData.sellerUid);
                loadRelatedProducts();
                loadReviews();

                document.getElementById('product-skeleton').classList.add('hidden');
                document.getElementById('product-content').classList.remove('hidden');
                updateProgress(100);
            } catch (e) { console.error(e); }
        }

    function renderProductUI() {
            document.getElementById('product-name').textContent = productData.name;
            document.getElementById('product-price-container').innerHTML = `<span class="text-4xl font-black text-mudalali-green">Rs. ${parseFloat(productData.price).toLocaleString()}</span>`;
            document.getElementById('main-product-image').src = productData.images?.[0] || productData.imageUrl;
            document.getElementById('product-description').innerHTML = productData.description?.replace(/\n/g, '<br>') || 'No description available.';
            document.getElementById('product-delivery').innerHTML = productData.deliveryDetails || 'Estimated delivery: 3-5 working days.';

            // Variation Logic - Fixed for Admin Panel Structure
            const varBox = document.getElementById('product-variations');
            varBox.innerHTML = '';
            
            // Admin Panel එකෙන් එන variations (Array of Objects)
            const variations = productData.variations || [];

            if (Array.isArray(variations)) {
                variations.forEach((vGroup) => {
                    // Check if name and options exist
                    if (!vGroup.name || !Array.isArray(vGroup.options)) return;

                    const div = document.createElement('div');
                    div.innerHTML = `<label class="text-[10px] font-black text-gray-400 uppercase tracking-widest block mb-3">${vGroup.name}</label>`;
                    
                    const group = document.createElement('div');
                    group.className = 'flex flex-wrap gap-3';
                    
                    vGroup.options.forEach((opt, i) => {
                        const btn = document.createElement('button');
                        btn.className = `variation-btn ${i === 0 ? 'active' : ''}`;
                        btn.textContent = opt;
                        
                        // Default selection
                        if (i === 0) selectedVars[vGroup.name] = opt;

                        btn.onclick = () => {
                            group.querySelectorAll('.variation-btn').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                            selectedVars[vGroup.name] = opt;
                        };
                        group.appendChild(btn);
                    });
                    
                    div.appendChild(group);
                    varBox.appendChild(div);
                });
            }
        }

        async function loadSellerData(uid) {
            if (!uid) return;
            const snap = await getDoc(doc(db, 'users', uid));
            if (snap.exists()) {
                const data = snap.data();
                document.getElementById('seller-name').textContent = data.displayName || 'Pink Store Verified';
                if (data.photoURL) document.getElementById('seller-logo').src = data.photoURL;
                document.getElementById('seller-store-link').href = `store.html?uid=${uid}`;
            }
        }

        async function loadRelatedProducts() {
            const grid = document.getElementById('related-products-grid');
            const q = query(collection(db, '/artifacts/default-app-id/public/data/products'), limit(5));
            const snap = await getDocs(q);
            grid.innerHTML = '';
            snap.forEach(d => {
                if (d.id === productId) return;
                const p = d.data();
                grid.innerHTML += `
                    <a href="product.html?id=${d.id}" class="flex gap-4 items-center bg-gray-50 p-2 rounded-2xl hover:bg-pink-50 transition-all border border-transparent hover:border-pink-100 group">
                        <img src="${p.imageUrl}" class="w-14 h-14 rounded-xl object-cover bg-white">
                        <div class="min-w-0">
                            <h4 class="text-xs font-bold truncate text-gray-800 group-hover:text-mudalali-green">${p.name}</h4>
                            <p class="text-[11px] text-mudalali-green font-black mt-1">Rs. ${parseFloat(p.price).toLocaleString()}</p>
                        </div>
                    </a>`;
            });
        }

        function loadReviews() {
            const list = document.getElementById('reviews-list');
            const q = query(collection(db, '/artifacts/default-app-id/public/data/productReviews'), 
                        where('productId', '==', productId), orderBy('createdAt', 'desc'));
            
            onSnapshot(q, snap => {
                if (snap.empty) {
                    list.innerHTML = '<p class="text-xs text-gray-400 italic text-center py-4">No reviews yet. Be the first!</p>';
                    return;
                }
                list.innerHTML = '';
                snap.forEach(d => {
                    const r = d.data();
                    list.innerHTML += `
                        <div class="p-4 bg-gray-50 rounded-2xl border border-gray-100">
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex text-yellow-400 text-[10px]">
                                    ${'<i class="fa fa-star"></i>'.repeat(r.rating || 5)}
                                </div>
                                <span class="text-[10px] text-gray-400 font-bold">${r.createdAt?.toDate().toLocaleDateString() || 'Recently'}</span>
                            </div>
                            <p class="text-sm text-gray-600">${r.text}</p>
                        </div>`;
                });
            });
        }

  async function addToCart(buyNow = false) {
    if (!currentUser) {
        alert("Please login to continue!");
        document.getElementById('account-drawer-modal')?.classList.remove('hidden');
        return;
    }
    
    const btn = buyNow ? document.getElementById('buy-now-btn') : document.getElementById('add-to-cart-btn');
    btn.disabled = true;

    // Variation අනුව unique cart ID එකක් හදනවා
    const varSuffix = Object.values(selectedVars).join('').replace(/\s/g, '');
    const cartId = productId + varSuffix;
    
    try {
        const cartData = {
            productId: productId,
            name: productData.name,
            price: parseFloat(productData.price),
            imageUrl: productData.images?.[0] || productData.imageUrl,
            quantity: increment(quantity), 
            variations: selectedVars,
            addedAt: serverTimestamp()
        };

        // Data එක Database එකට යනකම් හරියටම නවතිනවා (await)
// product.html ඇතුළේ
await setDoc(doc(db, 'users', currentUser.uid, 'cart', cartId), cartData, { merge: true });
if (buyNow) {
    setTimeout(() => {
        window.location.href = 'checkout.html';
    }, 1000); // 1 second delay
} else {
            document.getElementById('cart-drawer').classList.add('open');
        }
    } catch (e) {
        console.error("Cart Error:", e);
        alert("Failed to add to cart.");
    } finally {
        btn.disabled = false;
    }
}
        // --- UI HELPERS ---

        function updateProgress(v) { 
            const bar = document.getElementById('page-loader');
            bar.style.width = v + '%'; 
            if(v === 100) setTimeout(() => bar.style.opacity = '0', 500); 
        }

        // Global Remove Function
        window.removeFromCart = async (id) => {
            if(!currentUser) return;
            await deleteDoc(doc(db, 'users', currentUser.uid, 'cart', id));
        };

        // --- EVENT LISTENERS ---

        document.getElementById('qty-plus').onclick = () => { if(quantity < 10) quantity++; document.getElementById('qty-input').value = quantity; };
        document.getElementById('qty-minus').onclick = () => { if(quantity > 1) quantity--; document.getElementById('qty-input').value = quantity; };
        document.getElementById('add-to-cart-btn').onclick = () => addToCart(false);
        document.getElementById('buy-now-btn').onclick = () => addToCart(true);
        document.getElementById('cart-drawer-btn').onclick = () => document.getElementById('cart-drawer').classList.add('open');
        document.getElementById('close-cart').onclick = () => document.getElementById('cart-drawer').classList.remove('open');
        document.getElementById('cart-overlay').onclick = () => document.getElementById('cart-drawer').classList.remove('open');

        // Tab Switching
        ['desc', 'delivery', 'reviews'].forEach(t => {
            document.getElementById(`${t}-tab-btn`).onclick = () => {
                ['desc', 'delivery', 'reviews'].forEach(x => {
                    document.getElementById(`${x}-tab-btn`).classList.remove('active');
                    document.getElementById(`${x}-tab-panel`).classList.add('hidden');
                });
                document.getElementById(`${t}-tab-btn`).classList.add('active');
                document.getElementById(`${t}-tab-panel`).classList.remove('hidden');
            };
        });

        // Review Form Star Logic
        const stars = document.querySelectorAll('.rating-stars .star');
        let currentRating = 5;
        stars.forEach(s => {
            s.onclick = () => {
                currentRating = parseInt(s.dataset.value);
                stars.forEach(x => {
                    if(parseInt(x.dataset.value) <= currentRating) x.classList.add('selected');
                    else x.classList.remove('selected');
                });
            };
        });

        document.getElementById('review-form').onsubmit = async (e) => {
            e.preventDefault();
            const text = document.getElementById('review-text').value.trim();
            if(!text) return;
            try {
                await addDoc(collection(db, '/artifacts/default-app-id/public/data/productReviews'), {
                    productId, userId: currentUser.uid, rating: currentRating, text, createdAt: serverTimestamp()
                });
                document.getElementById('review-form').reset();
                alert("Review shared! Thank you.");
            } catch (e) { console.error(e); }
        };

        // Auth & Cart Sync
        onAuthStateChanged(auth, user => {
            currentUser = user;
            if (user) {
                document.getElementById('review-form-container').classList.remove('hidden');
                onSnapshot(collection(db, 'users', user.uid, 'cart'), snap => {
                    document.getElementById('cart-count-badge').textContent = snap.size;
                    const container = document.getElementById('cart-items-container');
                    let total = 0; 
                    container.innerHTML = snap.empty ? '<p class="text-center text-gray-400 mt-20 text-sm italic">Your bag is empty</p>' : '';
                    
                    snap.forEach(d => {
                        const item = d.data(); 
                        total += (parseFloat(item.price) * item.quantity);
                        container.innerHTML += `
                            <div class="flex gap-4 bg-gray-50 p-4 rounded-3xl relative group border border-transparent hover:border-pink-100 transition-all">
                                <img src="${item.imageUrl}" class="w-16 h-16 rounded-2xl object-cover bg-white shadow-sm">
                                <div class="min-w-0 flex-grow">
                                    <h4 class="text-[13px] font-bold truncate text-gray-800">${item.name}</h4>
                                    <p class="text-[10px] text-mudalali-green font-black mt-0.5">${Object.values(item.variations || {}).join(' / ')}</p>
                                    <div class="flex justify-between items-center mt-2">
                                        <p class="text-xs font-bold text-gray-500">Qty: ${item.quantity}</p>
                                        <p class="text-sm font-black text-gray-900">Rs. ${parseFloat(item.price).toLocaleString()}</p>
                                    </div>
                                </div>
                                <button onclick="removeFromCart('${d.id}')" class="absolute -top-1 -right-1 w-7 h-7 bg-white shadow-md rounded-full text-gray-300 hover:text-red-500 transition-colors flex items-center justify-center border border-gray-100">
                                    <i class="fa-solid fa-xmark text-[10px]"></i>
                                </button>
                            </div>`;
                    });
                    document.getElementById('cart-total-price').textContent = `Rs. ${total.toLocaleString()}`;
                });
            }
        });

        initProductPage();
    </script>
</body>
</html>